<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Element Dwell - Performance Monitor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0f172a;
            color: #e2e8f0;
            overflow-x: hidden;
        }
        
        .layout {
            display: grid;
            grid-template-columns: 400px 1fr;
            height: 100vh;
        }
        
        /* Monitor Panel */
        .monitor-panel {
            background: #1e293b;
            border-right: 1px solid #334155;
            overflow-y: auto;
            padding: 20px;
        }
        
        .monitor-section {
            background: #0f172a;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid #334155;
        }
        
        .monitor-title {
            font-size: 14px;
            font-weight: 600;
            color: #94a3b8;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #1e293b;
        }
        
        .metric:last-child {
            border-bottom: none;
        }
        
        .metric-label {
            font-size: 13px;
            color: #cbd5e1;
        }
        
        .metric-value {
            font-size: 14px;
            font-weight: 600;
            font-family: 'Courier New', monospace;
        }
        
        .metric-value.good { color: #10b981; }
        .metric-value.warning { color: #f59e0b; }
        .metric-value.bad { color: #ef4444; }
        
        /* Progress Bar */
        .progress-bar {
            width: 100%;
            height: 4px;
            background: #1e293b;
            border-radius: 2px;
            overflow: hidden;
            margin-top: 5px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #3b82f6);
            transition: width 0.3s ease;
        }
        
        /* Event Log */
        .event-log {
            max-height: 200px;
            overflow-y: auto;
            font-size: 11px;
            font-family: 'Courier New', monospace;
            background: #0a0f1a;
            padding: 10px;
            border-radius: 4px;
        }
        
        .log-entry {
            padding: 4px 0;
            border-bottom: 1px solid #1e293b;
            display: flex;
            gap: 8px;
        }
        
        .log-time {
            color: #64748b;
            min-width: 60px;
        }
        
        .log-event {
            color: #3b82f6;
            min-width: 80px;
        }
        
        .log-data {
            color: #94a3b8;
            flex: 1;
        }
        
        /* Controls */
        .controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .control-label {
            font-size: 12px;
            color: #94a3b8;
        }
        
        .control-input {
            background: #0f172a;
            border: 1px solid #334155;
            color: #e2e8f0;
            padding: 8px;
            border-radius: 4px;
            font-size: 13px;
        }
        
        .btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .btn:hover {
            background: #2563eb;
        }
        
        .btn.danger {
            background: #ef4444;
        }
        
        .btn.danger:hover {
            background: #dc2626;
        }
        
        /* Content Area */
        .content-area {
            overflow-y: auto;
            padding: 40px;
        }
        
        .test-element {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            padding: 40px;
            margin-bottom: 20px;
            color: white;
            position: relative;
            transition: all 0.3s;
        }
        
        .test-element.tracking {
            box-shadow: 0 0 0 4px #10b981;
        }
        
        .element-info {
            font-size: 12px;
            opacity: 0.8;
            margin-top: 10px;
        }
        
        .element-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
        }
        
        .element-stats {
            display: flex;
            gap: 20px;
            margin-top: 15px;
            font-size: 12px;
            font-family: 'Courier New', monospace;
        }
        
        .stat {
            background: rgba(0,0,0,0.2);
            padding: 8px 12px;
            border-radius: 4px;
        }
        
        /* Chart */
        .chart-container {
            width: 100%;
            height: 60px;
            position: relative;
            background: #0a0f1a;
            border-radius: 4px;
            margin-top: 10px;
            overflow: hidden;
        }
        
        .chart-bar {
            position: absolute;
            bottom: 0;
            width: 2px;
            background: #3b82f6;
            transition: height 0.1s ease;
        }
    </style>
</head>
<body>
    <div class="layout">
        <!-- Monitor Panel -->
        <div class="monitor-panel">
            <h1 style="font-size: 18px; margin-bottom: 20px; color: #f1f5f9;">
                üî¨ Performance Monitor
            </h1>
            
            <!-- Performance Metrics -->
            <div class="monitor-section">
                <div class="monitor-title">‚ö° Performance</div>
                <div class="metric">
                    <span class="metric-label">FPS</span>
                    <span class="metric-value good" id="fps">60</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Frame Time</span>
                    <span class="metric-value" id="frame-time">16ms</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Memory (JS Heap)</span>
                    <span class="metric-value" id="memory">0 MB</span>
                </div>
                <div class="chart-container" id="fps-chart"></div>
            </div>
            
            <!-- Observer Metrics -->
            <div class="monitor-section">
                <div class="monitor-title">üëÅÔ∏è Observer Stats</div>
                <div class="metric">
                    <span class="metric-label">Callback Count</span>
                    <span class="metric-value" id="callback-count">0</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Callback/sec</span>
                    <span class="metric-value" id="callback-rate">0</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Avg Callback Time</span>
                    <span class="metric-value" id="callback-time">0ms</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Active Thresholds</span>
                    <span class="metric-value" id="threshold-count">0</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="callback-progress" style="width: 0%"></div>
                </div>
            </div>
            
            <!-- Tracking Stats -->
            <div class="monitor-section">
                <div class="monitor-title">üìä Tracking Stats</div>
                <div class="metric">
                    <span class="metric-label">Elements Tracked</span>
                    <span class="metric-value" id="elements-tracked">0</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Currently Visible</span>
                    <span class="metric-value good" id="currently-visible">0</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Total Events</span>
                    <span class="metric-value" id="total-events">0</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Events/min</span>
                    <span class="metric-value" id="events-rate">0</span>
                </div>
            </div>
            
            <!-- Controls -->
            <div class="monitor-section">
                <div class="monitor-title">‚öôÔ∏è Controls</div>
                <div class="controls">
                    <div class="control-group">
                        <label class="control-label">Element Count</label>
                        <input type="range" class="control-input" id="element-count" min="1" max="50" value="5">
                        <span id="element-count-value" style="font-size: 12px; color: #64748b;">5 elements</span>
                    </div>
                    
                    <div class="control-group">
                        <label class="control-label">Trigger Mode</label>
                        <select class="control-input" id="trigger-mode">
                            <option value="immediate">Immediate</option>
                            <option value="elementCoverage">Element Coverage</option>
                            <option value="viewportPosition">Viewport Position</option>
                        </select>
                    </div>
                    
                    <div class="control-group">
                        <label class="control-label">Margin (px)</label>
                        <input type="number" class="control-input" id="margin-value" value="-100">
                    </div>
                    
                    <button class="btn" id="apply-btn">Apply Changes</button>
                    <button class="btn danger" id="reset-btn">Reset Stats</button>
                </div>
            </div>
            
            <!-- Event Log -->
            <div class="monitor-section">
                <div class="monitor-title">üìù Event Log</div>
                <div class="event-log" id="event-log"></div>
            </div>
        </div>
        
        <!-- Content Area -->
        <div class="content-area" id="content-area">
            <!-- Test elements will be generated here -->
        </div>
    </div>
    
    <script src="/dist/index.iife.js"></script>
    <script>
        const { createTracker, monitorElementDwell } = window.StlTracker;
        
        // Stats
        const stats = {
            fps: 60,
            frameTime: 0,
            callbackCount: 0,
            callbackTimes: [],
            lastCallbackTime: Date.now(),
            totalEvents: 0,
            eventTimes: [],
            fpsHistory: []
        };
        
        let tracker;
        let controller;
        let rafId;
        
        // Initialize
        function init() {
            createElements(5);
            initTracker();
            startMonitoring();
            setupControls();
        }
        
        // Create test elements
        function createElements(count) {
            const container = document.getElementById('content-area');
            container.innerHTML = '';
            
            for (let i = 0; i < count; i++) {
                const el = document.createElement('div');
                el.className = 'test-element';
                el.id = `test-${i}`;
                el.innerHTML = `
                    <div class="element-title">Test Element #${i + 1}</div>
                    <div class="element-info">Height: ${200 + i * 100}px</div>
                    <div class="element-stats">
                        <div class="stat">
                            <div>Coverage</div>
                            <div id="coverage-${i}">0%</div>
                        </div>
                        <div class="stat">
                            <div>Dwell Time</div>
                            <div id="dwell-${i}">0ms</div>
                        </div>
                        <div class="stat">
                            <div>Callbacks</div>
                            <div id="callbacks-${i}">0</div>
                        </div>
                    </div>
                `;
                el.style.height = `${200 + i * 100}px`;
                el.dataset.callbacks = '0';
                container.appendChild(el);
            }
        }
        
        // Initialize tracker
        function initTracker() {
            if (tracker) {
                tracker.destroy?.();
            }
            if (controller) {
                controller.stop();
            }
            
            const mode = document.getElementById('trigger-mode').value;
            const margin = document.getElementById('margin-value').value;
            
            tracker = createTracker({
                endpoint: "/collect",
                appId: "perf-test",
                batchSize: 1,
                flushIntervalMs: 250,
                fetcher: async (url, payload) => {
                    stats.totalEvents++;
                    stats.eventTimes.push(Date.now());
                    logEvent('event', payload.events?.[0]?.type || 'unknown');
                    return { ok: true };
                }
            });
            
            const configs = Array.from(document.querySelectorAll('.test-element')).map((el, i) => ({
                selector: `#${el.id}`,
                trigger: {
                    mode,
                    value: mode === 'immediate' ? 0 : 0.3,
                    margin: mode === 'immediate' ? `${margin}px` : undefined
                },
                throttleMs: 500,
                allowOversizeFallback: true,
                heartbeat: {
                    enabled: true,
                    intervalMs: 1000
                }
            }));
            
            // Wrap observer callback to measure performance
            controller = monitorElementDwell(tracker, configs);
            
            document.getElementById('elements-tracked').textContent = configs.length;
        }
        
        // Start monitoring
        function startMonitoring() {
            let lastTime = performance.now();
            let frames = 0;
            let lastFpsUpdate = Date.now();
            
            function tick() {
                const now = performance.now();
                const delta = now - lastTime;
                lastTime = now;
                
                stats.frameTime = delta;
                frames++;
                
                // Update FPS every second
                if (Date.now() - lastFpsUpdate >= 1000) {
                    stats.fps = frames;
                    frames = 0;
                    lastFpsUpdate = Date.now();
                    
                    stats.fpsHistory.push(stats.fps);
                    if (stats.fpsHistory.length > 60) stats.fpsHistory.shift();
                }
                
                updateUI();
                rafId = requestAnimationFrame(tick);
            }
            
            rafId = requestAnimationFrame(tick);
            
            // Update observer stats every 100ms
            setInterval(updateObserverStats, 100);
        }
        
        // Update UI
        function updateUI() {
            // FPS
            const fpsEl = document.getElementById('fps');
            fpsEl.textContent = stats.fps;
            fpsEl.className = 'metric-value ' + (stats.fps >= 55 ? 'good' : stats.fps >= 30 ? 'warning' : 'bad');
            
            document.getElementById('frame-time').textContent = stats.frameTime.toFixed(1) + 'ms';
            
            // Memory
            if (performance.memory) {
                const mb = (performance.memory.usedJSHeapSize / 1024 / 1024).toFixed(1);
                document.getElementById('memory').textContent = mb + ' MB';
            }
            
            // FPS Chart
            updateFpsChart();
            
            // Element states
            updateElementStates();
        }
        
        function updateFpsChart() {
            const chart = document.getElementById('fps-chart');
            const width = chart.offsetWidth;
            const maxBars = 60;
            
            chart.innerHTML = stats.fpsHistory.map((fps, i) => {
                const height = (fps / 60) * 100;
                const x = (width / maxBars) * i;
                return `<div class="chart-bar" style="left: ${x}px; height: ${height}%; background: ${fps >= 55 ? '#10b981' : fps >= 30 ? '#f59e0b' : '#ef4444'}"></div>`;
            }).join('');
        }
        
        function updateObserverStats() {
            // Callback rate
            const recentCallbacks = stats.callbackTimes.filter(t => Date.now() - t < 1000).length;
            document.getElementById('callback-rate').textContent = recentCallbacks;
            
            // Average callback time
            if (stats.callbackTimes.length > 0) {
                const recent = stats.callbackTimes.slice(-10);
                const avgTime = recent.reduce((sum, t, i, arr) => {
                    if (i === 0) return 0;
                    return sum + (arr[i] - arr[i-1]);
                }, 0) / (recent.length - 1);
                document.getElementById('callback-time').textContent = avgTime.toFixed(1) + 'ms';
            }
            
            // Events rate
            const recentEvents = stats.eventTimes.filter(t => Date.now() - t < 60000).length;
            document.getElementById('events-rate').textContent = recentEvents;
            document.getElementById('total-events').textContent = stats.totalEvents;
            
            // Progress bar
            const progress = Math.min(100, (recentCallbacks / 30) * 100);
            document.getElementById('callback-progress').style.width = progress + '%';
        }
        
        function updateElementStates() {
            if (!controller) return;
            
            const snapshots = controller.getSnapshots();
            let visibleCount = 0;
            
            snapshots.forEach(snapshot => {
                const match = snapshot.selector.match(/#test-(\d+)/);
                if (!match) return;
                
                const idx = parseInt(match[1]);
                const el = document.getElementById(`test-${idx}`);
                
                if (snapshot.visibleNow) {
                    visibleCount++;
                    el.classList.add('tracking');
                } else {
                    el.classList.remove('tracking');
                }
                
                document.getElementById(`coverage-${idx}`).textContent = 
                    (snapshot.elementCoverage * 100).toFixed(0) + '%';
                document.getElementById(`dwell-${idx}`).textContent = 
                    snapshot.dwellMs + 'ms';
            });
            
            document.getElementById('currently-visible').textContent = visibleCount;
        }
        
        // Log event
        function logEvent(type, data) {
            const log = document.getElementById('event-log');
            const time = new Date().toLocaleTimeString('ko-KR', { hour12: false });
            
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.innerHTML = `
                <span class="log-time">${time}</span>
                <span class="log-event">${type}</span>
                <span class="log-data">${typeof data === 'object' ? JSON.stringify(data).slice(0, 50) : data}</span>
            `;
            
            log.insertBefore(entry, log.firstChild);
            
            if (log.children.length > 50) {
                log.removeChild(log.lastChild);
            }
        }
        
        // Setup controls
        function setupControls() {
            document.getElementById('element-count').addEventListener('input', (e) => {
                document.getElementById('element-count-value').textContent = e.target.value + ' elements';
            });
            
            document.getElementById('apply-btn').addEventListener('click', () => {
                const count = parseInt(document.getElementById('element-count').value);
                createElements(count);
                initTracker();
                logEvent('config', `Applied: ${count} elements`);
            });
            
            document.getElementById('reset-btn').addEventListener('click', () => {
                stats.callbackCount = 0;
                stats.callbackTimes = [];
                stats.totalEvents = 0;
                stats.eventTimes = [];
                stats.fpsHistory = [];
                document.getElementById('callback-count').textContent = '0';
                document.getElementById('event-log').innerHTML = '';
                logEvent('system', 'Stats reset');
            });
        }
        
        // Intercept IntersectionObserver
        const OriginalObserver = window.IntersectionObserver;
        window.IntersectionObserver = class extends OriginalObserver {
            constructor(callback, options) {
                const wrappedCallback = (entries, observer) => {
                    const start = performance.now();
                    stats.callbackCount++;
                    stats.callbackTimes.push(Date.now());
                    
                    // Track per-element callbacks
                    entries.forEach(entry => {
                        const el = entry.target;
                        if (el.dataset.callbacks !== undefined) {
                            el.dataset.callbacks = parseInt(el.dataset.callbacks) + 1;
                            const idx = el.id.split('-')[1];
                            if (idx) {
                                document.getElementById(`callbacks-${idx}`).textContent = el.dataset.callbacks;
                            }
                        }
                    });
                    
                    callback(entries, observer);
                    
                    const duration = performance.now() - start;
                    if (duration > 16) {
                        logEvent('warning', `Slow callback: ${duration.toFixed(1)}ms`);
                    }
                };
                
                super(wrappedCallback, options);
                
                // Log threshold count
                if (options?.threshold) {
                    const count = Array.isArray(options.threshold) ? options.threshold.length : 1;
                    document.getElementById('threshold-count').textContent = count;
                    logEvent('observer', `Created with ${count} thresholds`);
                }
            }
        };
        
        // Initialize on load
        window.addEventListener('load', init);
    </script>
</body>
</html>
